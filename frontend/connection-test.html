<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend Connection Test</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        .test-result {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            border: 2px solid;
        }
        .test-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .test-error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .test-info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        code {
            background: var(--bg-tertiary);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <h1>Backend Connection Test</h1>
            <p>This page tests the connection to your backend server.</p>
            
            <button class="btn btn-primary" onclick="runTests()" style="width: 100%; margin-top: 1rem;">
                <i class="fas fa-sync"></i> Run Tests
            </button>
            
            <div id="test-results" style="margin-top: 2rem;">
                <!-- Test results will appear here -->
            </div>
            
            <div style="margin-top: 2rem;">
                <a href="index.html" class="btn btn-secondary" style="width: 100%;">
                    <i class="fas fa-arrow-left"></i> Back to Home
                </a>
            </div>
        </div>
    </div>

    <script>
        async function runTests() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<div class="loader"></div>';
            
            const tests = [];
            const API_BASE = 'http://localhost:5000';
            
            // Test 1: Health Check
            tests.push(testHealthCheck(API_BASE));
            
            // Test 2: CORS
            tests.push(testCORS(API_BASE));
            
            // Test 3: API Endpoints
            tests.push(testAPIEndpoints(API_BASE));
            
            // Run all tests
            const results = await Promise.all(tests);
            
            // Display results
            displayResults(results);
        }
        
        async function testHealthCheck(apiBase) {
            try {
                const response = await fetch(`${apiBase}/health`);
                const data = await response.json();
                
                return {
                    name: 'Health Check',
                    status: response.ok ? 'success' : 'error',
                    message: response.ok 
                        ? `Server is running! JWT_SECRET: ${data.env?.hasJWTSecret ? '‚úÖ Set' : '‚ùå Missing'}, MongoDB: ${data.env?.hasMongoURI ? '‚úÖ Set' : '‚ùå Missing'}`
                        : `Server returned status ${response.status}`,
                    details: data
                };
            } catch (error) {
                return {
                    name: 'Health Check',
                    status: 'error',
                    message: `Cannot connect to backend: ${error.message}`,
                    details: error
                };
            }
        }
        
        async function testCORS(apiBase) {
            try {
                const response = await fetch(`${apiBase}/health`, {
                    method: 'OPTIONS',
                });
                
                return {
                    name: 'CORS Check',
                    status: 'success',
                    message: 'CORS is configured correctly',
                    details: {
                        status: response.status,
                        headers: Object.fromEntries(response.headers.entries())
                    }
                };
            } catch (error) {
                return {
                    name: 'CORS Check',
                    status: 'error',
                    message: `CORS error: ${error.message}`,
                    details: error
                };
            }
        }
        
        async function testAPIEndpoints(apiBase) {
            const endpoints = [
                '/api/settings',
                '/api/funfacts',
                '/api/artworks',
            ];
            
            const results = [];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${apiBase}${endpoint}`);
                    const status = response.ok ? 'success' : 'error';
                    const message = response.ok 
                        ? `Endpoint ${endpoint} is accessible`
                        : `Endpoint ${endpoint} returned status ${response.status}`;
                    
                    results.push({
                        name: `API: ${endpoint}`,
                        status,
                        message,
                        details: { status: response.status }
                    });
                } catch (error) {
                    results.push({
                        name: `API: ${endpoint}`,
                        status: 'error',
                        message: `Cannot access ${endpoint}: ${error.message}`,
                        details: error
                    });
                }
            }
            
            return {
                name: 'API Endpoints',
                status: results.every(r => r.status === 'success') ? 'success' : 'error',
                message: `${results.filter(r => r.status === 'success').length}/${results.length} endpoints accessible`,
                details: results
            };
        }
        
        function displayResults(results) {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';
            
            results.forEach(result => {
                const div = document.createElement('div');
                div.className = `test-result test-${result.status === 'success' ? 'success' : 'error'}`;
                
                let detailsHTML = '';
                if (result.details) {
                    if (Array.isArray(result.details)) {
                        detailsHTML = '<ul style="margin-top: 0.5rem;">';
                        result.details.forEach(detail => {
                            detailsHTML += `<li>${detail.name}: ${detail.message}</li>`;
                        });
                        detailsHTML += '</ul>';
                    } else {
                        detailsHTML = `<pre style="margin-top: 0.5rem; font-size: 0.875rem; overflow-x: auto;">${JSON.stringify(result.details, null, 2)}</pre>`;
                    }
                }
                
                div.innerHTML = `
                    <h3>${result.status === 'success' ? '‚úÖ' : '‚ùå'} ${result.name}</h3>
                    <p>${result.message}</p>
                    ${detailsHTML}
                `;
                
                resultsDiv.appendChild(div);
            });
            
            // Add troubleshooting tips
            const hasErrors = results.some(r => r.status === 'error');
            if (hasErrors) {
                const tipsDiv = document.createElement('div');
                tipsDiv.className = 'test-result test-info';
                tipsDiv.innerHTML = `
                    <h3>üîß Troubleshooting Tips</h3>
                    <ul style="text-align: left; margin-top: 0.5rem;">
                        <li>Make sure backend server is running: <code>cd backend && npm start</code></li>
                        <li>Check that backend is running on <code>http://localhost:5000</code></li>
                        <li>Check backend console for errors</li>
                        <li>Verify .env file exists and has all required variables</li>
                        <li>Make sure you're opening frontend via <code>http://localhost:8000</code> (not file://)</li>
                        <li>Check browser console (F12) for detailed error messages</li>
                    </ul>
                `;
                resultsDiv.appendChild(tipsDiv);
            }
        }
        
        // Auto-run tests on page load
        window.addEventListener('load', () => {
            setTimeout(runTests, 500);
        });
    </script>
</body>
</html>

